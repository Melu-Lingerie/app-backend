**ML-001** - Как посетитель, я хочу просматривать каталог товаров без регистрации, чтобы оценить ассортимент и качество продукции перед покупкой

## Постановка задачи для бэкенд-разработчика
**Тема:** «Публичный просмотр каталога товаров без регистрации»

### 1. Цель
Обеспечить анонимным посетителям полный доступ к каталогу товаров для ознакомления с ассортиментом, ценами и качеством продукции без требования регистрации или аутентификации.

### 2. Требования к API

| Параметр             | Описание                                                                           |
|----------------------|------------------------------------------------------------------------------------|
| `GET api/v1/catalog` | Публичный endpoint без проверки авторизации.                                       |
| Headers              | `Authorization` опциональный — если передан, можно показать персональные элементы. |
| Query-параметры      | `cursor` (base64), `limit` (≤50), стандартные фильтры.                             |
| Rate-limit           | 200 req/min/IP для анонимных пользователей (выше чем для авторизованных).          |
| Ответ                | `{ items, nextCursor, hasMore, totalVisible }`                                     |

### 3. Логика выборки для анонимных пользователей

```sql
WITH active_prices AS (
  SELECT DISTINCT ON (product_id) 
         product_id, 
         price
    FROM product_prices
   ORDER BY product_id, updated_at DESC
),
main_images AS (
  SELECT DISTINCT ON (product_id)
         product_id,
         image_url,
         alt_text
    FROM product_images
   WHERE image_type = 'main'
   ORDER BY product_id, sort_order ASC
)
SELECT p.id,
       p.name,
       p.slug,
       COALESCE(ap.price, p.base_price) as current_price,
       p.base_price,
       c.name as category_name,
       c.slug as category_slug,
       mi.image_url as main_image,
       mi.alt_text as image_alt,
       (SELECT COUNT(*) FROM product_variants pv 
        WHERE pv.product_id = p.id AND pv.is_available = TRUE) as available_variants
  FROM products p
  JOIN categories c ON c.id = p.category_id
  LEFT JOIN active_prices ap ON ap.product_id = p.id
  LEFT JOIN main_images mi ON mi.product_id = p.id
 WHERE p.is_active = TRUE
   AND c.is_active = TRUE
   AND (p.sort_index, p.created_at, p.id) > (:sIdx, :cAt, :pId)
 ORDER BY p.sort_index ASC, p.created_at DESC, p.id DESC
 LIMIT :limit;
```

### 4. Ограничения для анонимных пользователей

| Данные                  | Показывать                            | Скрывать                        |
|-------------------------|---------------------------------------|---------------------------------|
| **Основная информация** | Название, описание, цена, изображения | SKU, внутренние коды            |
| **Наличие**             | Общий статус доступности              | Точное количество на складе     |
| **Варианты**            | Количество доступных вариантов        | Детальную информацию по каждому |
| **Отзывы**              | Средний рейтинг, количество           | Тексты отзывов (опционально)    |

### 5. Кэширование для публичного доступа

| Слой         | Политика                                                                   |
|--------------|----------------------------------------------------------------------------|
| **CDN**      | `Cache-Control: public,max-age=300,s-maxage=600` — агрессивное кеширование |
| **Edge**     | CloudFlare/AWS Lambda@Edge для базовых фильтров                            |
| **Redis**    | `anon_catalog:{hash(filters)}:{cursor}:{limit}` TTL = 120 с                |
| **Database** | Connection pooling с отдельным pool для анонимного трафика                 |

### 6. Индексы для производительности

```sql
-- Основной индекс для курсорной пагинации
CREATE INDEX IF NOT EXISTS idx_products_public_sort
  ON products (sort_index ASC, created_at DESC, id DESC)
  WHERE is_active = TRUE;

-- Индекс для категорий  
CREATE INDEX IF NOT EXISTS idx_categories_active_slug
  ON categories (is_active, slug)
  WHERE is_active = TRUE;

-- Составной индекс для цен
CREATE INDEX IF NOT EXISTS idx_product_prices_latest
  ON product_prices (product_id, updated_at DESC);

-- Индекс для главных изображений
CREATE INDEX IF NOT EXISTS idx_product_images_main
  ON product_images (product_id, sort_order)
  WHERE image_type = 'main';
```

### 7. Безопасность и ограничения

| Аспект            | Реализация                                                         |
|-------------------|--------------------------------------------------------------------|
| **DDoS защита**   | CloudFlare с JS Challenge для подозрительного трафика              |
| **Rate limiting** | 200 req/min/IP через Nginx rate_limit_zone                         |
| **Data leakage**  | Исключить поля: `sku`, `cost_price`, `supplier_id`, точные остатки |
| **Bot detection** | User-Agent анализ, блокировка явных скраперов                      |

### 8. Сервисный слой (Java/Spring пример)

```java
@RestController
@RequestMapping("api/v1/catalog")
public class CatalogController {
    
    @GetMapping
    public ResponseEntity getCatalog(
            @RequestParam(required = false) String cursor,
            @RequestParam(defaultValue = "24") @Max(50) Integer limit,
            @RequestParam(required = false) List categories,
            HttpServletRequest request) {
        
        // Проверка rate limit
        String clientIP = getClientIP(request);
        if (!rateLimitService.isAllowed(clientIP, 200)) {
            return ResponseEntity.status(429).build();
        }
        
        // Декодирование курсора
        CursorData cursorData = cursor != null ? 
            cursorService.decode(cursor) : 
            CursorData.initial();
        
        // Построение кэш-ключа
        String cacheKey = buildCacheKey("anon_catalog", categories, cursor, limit);
        
        // Попытка получить из кэша
        CatalogResponse cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return ResponseEntity.ok(cached);
        }
        
        // Выборка из БД
        List products = catalogRepository.findPublicProducts(
            cursorData, limit, categories);
        
        // Построение ответа
        CatalogResponse response = CatalogResponse.builder()
            .items(products)
            .nextCursor(products.size() == limit ? 
                cursorService.encode(products.get(products.size() - 1)) : null)
            .hasMore(products.size() == limit)
            .build();
        
        // Сохранение в кэш
        redisTemplate.opsForValue().set(cacheKey, response, 
            Duration.ofSeconds(120));
        
        return ResponseEntity.ok()
            .cacheControl(CacheControl.maxAge(Duration.ofSeconds(300)))
            .body(response);
    }
}
```

### 9. DTO для анонимных пользователей

```java
@Data
@Builder
public class PublicProductDTO {
    private Long id;
    private String name;
    private String slug;
    private BigDecimal currentPrice;
    private BigDecimal basePrice;
    private String categoryName;
    private String categorySlug;
    private String mainImage;
    private String imageAlt;
    private Integer availableVariants;
    
    // Исключенные поля: sku, costPrice, supplierId, stockQuantity
}
```

### 10. Мониторинг и алерты

| Метрика                            | Цель                           | Alert            |
|------------------------------------|--------------------------------|------------------|
| `catalog_anonymous_requests_total` | Трафик анонимных пользователей | > 10k req/min    |
| `catalog_anonymous_latency_ms`     | p95 время ответа               | > 300 ms (5 min) |
| `catalog_cache_hit_ratio`          | Эффективность кеширования      | 5% (5 min)       |

### 11. Тестирование

| Тип             | Кейс                                                                  |
|-----------------|-----------------------------------------------------------------------|
| **Functional**  | Анонимный пользователь получает каталог без заголовка `Authorization` |
| **Security**    | Отсутствие внутренних полей в ответе (SKU, остатки)                   |
| **Performance** | 2,000 RPS анонимного трафика, p95                                     

### 12. План внедрения

1. **Создать индексы** с `CONCURRENTLY` на продакшене
2. **Настроить CDN** с агрессивным кешированием для анонимов
3. **Имплементировать endpoint** без проверки авторизации
4. **Feature flag**: постепенный rollout 10% → 100%
5. **Мониторинг**: настроить метрики и алерты
6. **SEO**: добавить server-side rendering и структурированные данные

### 13. Риски и митигация

| Риск                             | Митигация                          |
|----------------------------------|------------------------------------|
| **Высокая нагрузка от анонимов** | CDN + Redis кэш + rate limiting    |
| **Утечка коммерческих данных**   | Strict whitelist полей в DTO       |
| **Скрапинг конкурентами**        | Bot detection + CAPTCHA challenges |

### 14. Критерии готовности

- ✅ Анонимный пользователь видит каталог без регистрации
- ✅ p95 latency  90%
- ✅ Отсутствие internal полей в JSON ответах
- ✅ SEO-friendly структура с SSR
- ✅ Rate limiting работает корректно